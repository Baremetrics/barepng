<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1">

  <style>
    html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,hgroup,menu,nav,output,ruby,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section{display:block}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}table{border-collapse:collapse;border-spacing:0}*{box-sizing:border-box}body,html{width:100%;height:100%}body{background-color:#FFF;font-family:'Proxima Nova', sans-serif}svg text{fill:#FFF;font-family:'Proxima Nova', sans-serif}svg .area{fill:rgba(255, 255, 255, 0.1)}svg .line{stroke:#FFF}svg .tick line{stroke:rgba(255, 255, 255, 0.1)}svg .gradient{width:800px;height:400px;fill:url(#gradient)}
  </style>

  <script src="https://code.jquery.com/jquery-2.2.2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/moment.min.js"></script>
</head>
<body>
  <svg width="800" height="400" data-array="[[1456271999000,43858.0],[1456358399000,43991.0],[1456444799000,44192.0],[1456531199000,44289.0],[1456617599000,44367.0],[1456703999000,44413.0],[1456790399000,44443.0],[1456876799000,44791.0],[1456963199000,44789.0],[1457049599000,45138.0],[1457135999000,45173.0],[1457222399000,45159.0],[1457308799000,45191.0],[1457395199000,45372.0],[1457481599000,45357.0],[1457567999000,45408.0],[1457654399000,45458.0],[1457740799000,45845.0],[1457827199000,45889.0],[1457913599000,45939.0],[1457999999000,45983.0],[1458086399000,46054.0],[1458172799000,45443.0],[1458259199000,45707.0],[1458345599000,45170.0],[1458431999000,45301.0],[1458518399000,45298.0],[1458604799000,45384.0],[1458691199000,45741.0]]">
    <rect class="gradient"></rect>
    <linearGradient id="gradient" x1="0" y1="0" x2="100%" y2="100%"><stop offset="0%" stop-color="#2693d5"></stop><stop offset="100%" stop-color="#41b7cc"></stop></linearGradient>
  </svg>

  <script type="text/javascript">
    Graph = function() {
      this.element = $('svg');
      this.svg = d3.select(this.element[0]);

      this.data = this.element.data('array');
      
      this.dates = null;
      this.amounts = null;

      this.width = null;
      this.height = null;

      this.xScale = null;
      this.yScale = null;
      this.xAxis = null;
      this.yAxis = null;
    }

    Graph.prototype.draw = function() {
      var self = this;

      this.dates = _.map(this.data, function(d) {
        return d[0];
      });

      this.amounts = _.map(this.data, function(d) {
        return d[1];
      });

      this.width = this.element.width();
      this.height = this.element.height();

      this.yScale = d3.scale.linear()
        .domain(d3.extent(this.amounts))
        .range([this.height - 72, 24]);

      this.xScale = d3.scale.linear()
        .domain(d3.extent(this.dates))
        .range([0, this.width]);

      this.yAxis = d3.svg.axis()
        // .tickFormat(function(d) {
        //   return $$(d);
        // })
        .ticks(6)
        .tickPadding(24)
        .tickSize(0, 0)
        .scale(this.yScale)
        .orient('right');
        
      this.svg.append('g').attr('class', 'axis axis--y');

      this.svg.select('.axis--y')
        .call(this.yAxis);

      var offset = d3.max($('.axis--y text').map(function(i, d) {
        return d.getBBox().width + 24;
      }));

      this.svg.select('.axis--y')
        .selectAll('line').attr({
          x2: this.width - 24,
          x1: offset + 12
        });

      this.xScale
        .range([offset + 12, this.width - 24]);

      this.xAxis = d3.svg.axis()
        .tickValues(this.dates)
        .tickFormat(function(d) {
          return moment(d).format('MMM D');
        })
        .tickPadding(0)
        .tickSize(0, 0)
        .scale(this.xScale)
        .orient('top');

      this.svg.append('g')
        .attr({
          'class': 'axis axis--x',
          transform: 'translate('+ [0, this.height - 24] +')'
        });

      this.svg.select('.axis--x')
        .call(this.xAxis);

      // If there are text elements outside the range, kill them
      var widths = [];
      var minWidth;
      var targetRight;

      $('svg .axis--x .tick text').css('opacity', 0);

      $('svg .axis--x .tick').each(function() {
        widths.push(this.getBBox().width);
      });

      var maxWidthHalf = d3.max(widths) / 2 + 12;

      $('svg .axis--x .tick text').each(function(i) {
        var center = $(this).prev().position().left;

        if (i == 0 || center - maxWidthHalf > targetRight) {
          if ($(this).position().left - 12 < targetRight)
            return true;

          if ($(this).position().left + $(this)[0].getBBox().width > self.element.width())
            return true;

          targetRight = center + maxWidthHalf;
          return $(this).css('opacity', 1);
        }
      });

      $('.domain').remove();

      self.lineGraph(this.data);
    }

    Graph.prototype.lineGraph = function(data) {
      var self = this;

      var area = d3.svg.area()
        .x(function(d) {return self.xScale(d[0])})
        .y0(this.height - 48)
        .y1(function(d) {return self.yScale(d[1])});

      this.svg.append('path')
        .data([data])
        .attr({
          'class': 'area',
          d: area
        });

      var line = d3.svg.line()
        .x(function(d) {return self.xScale(d[0])})
        .y(function(d) {return self.yScale(d[1])});

      this.svg.append('path')
        .data([data])
        .attr({
          'class': 'line',
          d: line,
          fill: 'none',
          'stroke-width': 5,
          'stroke-linecap': 'round',
          "stroke-linejoin": 'round'
        });
    }

    var graph = new Graph();
    graph.draw();
  </script>
</body>
</html>